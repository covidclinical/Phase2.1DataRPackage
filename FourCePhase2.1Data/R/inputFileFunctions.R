## This file contains functions related to file system locations where the site-specific 
## data will reside.

#' Returns the name of the root of the file system location to be used as workspace.
#'
#' @keywords 4CE
#' @export

get4ceRootDirectoryName <- function() {
    return("/4ceData")
}

#' Returns the name of the directory where site input data is expected to reside.
#'
#' @param fullyQualified Should the return value be a fully-qualified path?  If not, just the name of the directory is returned.
#' @keywords 4CE
#' @export

getInputDataDirectoryName <- function(fullyQualified=TRUE) {

    if (fullyQualified) {
        return(
            file.path(
                get4ceRootDirectoryName(), 
                getInputDataDirectoryName(fullyQualified=FALSE)
            )
        )
    } else {
        ## the relative path is hardcoded
        return("Input")
    }
}

#' Returns the name of the site whose files are in the directory returned by getInputDataDirectoryName().
#' Throws an error if files are inconsistently named, or if files for multiple site ids are present,
#' or if required files are missing.
#'
#' @keywords 4CE
#' @export

getSiteId <- function() {

    ## enumerate files in the input data directory
    fNames = list.files(getInputDataDirectoryName())

    ## we are supposed to find a single match to each of these file name patterns
    fNamePatterns = c(
        "Labs-.+\\.csv",
        "Medications-.+\\.csv",
        "Diagnoses-.+\\.csv",
        "Demographics-.+\\.csv",
        "DailyCounts-.+\\.csv",
        "ClinicalCourse-.+\\.csv"
    )

    siteId = NA
    
    # Compile errors into a list.
    errors = list()

    ## for each file pattern we are supposed to match
    for (currFNamePattern in fNamePatterns) {

        ix = grep(pattern=currFNamePattern, x=fNames)

        # Note if we find no match.
        if (length(ix) == 0) {
            errors[[currFNamePattern]] =
                paste("No match found for file name pattern:", currFNamePattern)
            next
        }

        # Note if we find multiple matches
        if (length(ix) > 1) {
            errors[[currFNamePattern]] =
                paste("Multiple matches found for file name pattern: ",
                      currFNamePattern, ": ", paste(fNames[ix], collapse=", "))
            next
        }

        # So we have exactly one match, make sure all files are named for the same site ID
        prefixSuffix = strsplit(x=currFNamePattern, split=".+\\", fixed=TRUE)[[1]]
        currSiteId = 
            gsub(
                x = gsub(
                    x = fNames[ix],
                    pattern=prefixSuffix[1],
                    replacement=""
                ),
                pattern=prefixSuffix[2],
                replacement=""
            )
        
        if (is.na(siteId)) {
            siteId = currSiteId
        }

        if (siteId != currSiteId) {
            errors[[currFNamePattern]] =
                paste0("Files for multiple sites found in the input data directory: ",
                       siteId, ", ", currSiteId)
        }
    }
    
    if (length(errors) > 0) {
        cat("Error(s) found in getSiteId():\n")
        cat(" *", paste(unname(errors), collapse = "\n * "), "\n")
        stop("Could not complete getSiteId(). See https://github.com/covidclinical/Phase2.1DataRPackage for help.")
    }
    
    return(siteId)
}
